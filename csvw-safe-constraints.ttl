@prefix sh:        <http://www.w3.org/ns/shacl#> .
@prefix rdf:       <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix xsd:       <http://www.w3.org/2001/XMLSchema#> .
@prefix csvw:      <http://www.w3.org/ns/csvw#> .
@prefix csvw-safe: <https://w3id.org/csvw-safe#> .

#################################################################
# TABLE LEVEL
#################################################################

csvw-safe:TableShape
    a sh:NodeShape ;
    sh:targetClass csvw:Table ;

    # public.length ≤ bounds.maxLength
    sh:sparql [
        sh:message "public.length must be ≤ bounds.maxLength." ;
        sh:select """
            SELECT $this WHERE {
                $this csvw-safe:public.length ?pl ;
                      csvw-safe:bounds.maxLength ?ml .
                FILTER (?pl > ?ml)
            }
        """ ;
    ] ;

    # bounds.maxContributions ≤ bounds.maxLength
    sh:sparql [
        sh:message "bounds.maxContributions must be ≤ bounds.maxLength." ;
        sh:select """
            SELECT $this WHERE {
                $this csvw-safe:bounds.maxContributions ?mc ;
                      csvw-safe:bounds.maxLength ?ml .
                FILTER (?mc > ?ml)
            }
        """ ;
    ] .

#################################################################
# COLUMN LEVEL
#################################################################

csvw-safe:ColumnShape
    a sh:NodeShape ;
    sh:targetClass csvw:Column ;

    # nullableFraction between 0 and 1
    sh:property [
        sh:path csvw-safe:nullableFraction ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:maxInclusive 1 ;
    ] .

#################################################################
# GROUPING KEY LEVEL
#################################################################

csvw-safe:GroupingKeyShape
    a sh:NodeShape ;
    sh:targetClass csvw-safe:GroupingKey ;

    # must have at least 2 columns
    sh:property [
        sh:path csvw-safe:columns ;
        sh:minCount 2 ;
    ] ;

    # public.length ≤ bounds.maxLength
    sh:sparql [
        sh:message "Grouping public.length must be ≤ bounds.maxLength." ;
        sh:select """
            SELECT $this WHERE {
                $this csvw-safe:public.length ?pl ;
                      csvw-safe:bounds.maxLength ?ml .
                FILTER (?pl > ?ml)
            }
        """ ;
    ] ;

    # bounds.maxContributions ≤ bounds.maxLength
    sh:sparql [
        sh:message "Grouping bounds.maxContributions must be ≤ bounds.maxLength." ;
        sh:select """
            SELECT $this WHERE {
                $this csvw-safe:bounds.maxContributions ?mc ;
                      csvw-safe:bounds.maxLength ?ml .
                FILTER (?mc > ?ml)
            }
        """ ;
    ] .

#################################################################
# PARTITION LEVEL
#################################################################

csvw-safe:PartitionShape
    a sh:NodeShape ;
    sh:targetClass csvw-safe:Partition ;

    # must have predicate
    sh:property [
        sh:path csvw-safe:predicate ;
        sh:minCount 1 ;
    ] ;

    # public.length ≤ bounds.maxLength
    sh:sparql [
        sh:message "Partition public.length must be ≤ bounds.maxLength." ;
        sh:select """
            SELECT $this WHERE {
                $this csvw-safe:public.length ?pl ;
                      csvw-safe:bounds.maxLength ?ml .
                FILTER (?pl > ?ml)
            }
        """ ;
    ] .

#################################################################
# PREDICATE LEVEL (Numeric interval correctness)
#################################################################

csvw-safe:PredicateShape
    a sh:NodeShape ;
    sh:targetClass csvw-safe:Predicate ;

    sh:sparql [
        sh:message "lowerBound must be ≤ upperBound." ;
        sh:select """
            SELECT $this WHERE {
                $this csvw-safe:lowerBound ?l ;
                      csvw-safe:upperBound ?u .
                FILTER (?l > ?u)
            }
        """ ;
    ] .

#################################################################
# CONTRIBUTION LEVEL
#################################################################

csvw-safe:ContributionShape
    a sh:NodeShape ;
    sh:targetClass csvw-safe:Contribution ;

    # maxContributions must be non-negative
    sh:property [
        sh:path csvw-safe:contribution.maxContributions ;
        sh:datatype xsd:integer ;
        sh:minInclusive 0 ;
    ] ;

    sh:property [
        sh:path csvw-safe:contribution.maxGroupsPerUnit ;
        sh:datatype xsd:integer ;
        sh:minInclusive 0 ;
    ] .