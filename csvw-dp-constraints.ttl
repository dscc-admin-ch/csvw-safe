@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix dp: <https://w3id.org/csvw-dp#> .
@prefix csvw: <http://www.w3.org/ns/csvw#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

#################################################################
# SHACL shapes for CSVW-DP constraints
#################################################################

# ===============================================================
# 1. Base shape for all DP-bounded entities
# ===============================================================
dp:DPBoundedShape
  a sh:NodeShape ;
  sh:targetClass dp:DPBounded ;
  sh:property [
    sh:path dp:maxPartitionLength ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 0 ;
  ] ;
  sh:property [
    sh:path dp:maxPartitionContribution ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 0 ;
  ] ;
  sh:property [
    sh:path dp:maxInfluencedPartitions ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 1 ;
  ] ;
  sh:property [
    sh:path dp:partitionLength ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 0 ;
    sh:optional true ;
  ] ;
  sh:property [
    sh:path dp:maxNumPartitions ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 1 ;
    sh:optional true ;
  ] .

# ===============================================================
# 2. Column-level constraints
# ===============================================================
dp:ColumnShape
  a sh:NodeShape ;
  sh:targetClass csvw:Column ;
  sh:property [
    sh:path dp:privacyId ;
    sh:datatype xsd:boolean ;
  ] ;
  sh:property [
    sh:path dp:nullableProportion ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 0 ;
    sh:maxInclusive 1 ;
  ] ;
  sh:property [
    sh:path dp:maxPartitionLength ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 0 ;
  ] ;
  sh:property [
    sh:path dp:maxPartitionContribution ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 0 ;
  ] ;
  sh:property [
    sh:path dp:maxInfluencedPartitions ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 1 ;
  ] ;
  sh:property [
    sh:path dp:maxNumPartitions ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 1 ;
    sh:optional true ;
  ] .

# ===============================================================
# 3. Multi-column group constraints
# ===============================================================
dp:ColumnGroupShape
  a sh:NodeShape ;
  sh:targetClass dp:ColumnGroup ;
  sh:property [
    sh:path dp:columns ;
    sh:minCount 2 ;
  ] ;
  sh:property [
    sh:path dp:maxPartitionLength ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 0 ;
  ] ;
  sh:property [
    sh:path dp:maxPartitionContribution ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 0 ;
  ] ;
  sh:property [
    sh:path dp:maxInfluencedPartitions ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 1 ;
  ] ;
  sh:property [
    sh:path dp:maxNumPartitions ;
    sh:datatype xsd:decimal ;
    sh:minInclusive 1 ;
  ] ;
  sh:property [
    sh:path dp:publicPartitions ;
    sh:nodeKind sh:IRIOrBlankNode ;
    sh:class dp:PartitionKeyShape ;
  ] .

# ===============================================================
# 4. Partition-level constraints
# ===============================================================
dp:PartitionKeyShape
  a sh:NodeShape ;
  sh:targetClass dp:PartitionKey ;
  sh:property [
    sh:path dp:partitionValue ;
    sh:datatype xsd:string ;
    sh:optional true ;
  ] ;
  sh:property [
    sh:path dp:lowerBound ;
    sh:datatype xsd:decimal ;
    sh:optional true ;
  ] ;
  sh:property [
    sh:path dp:upperBound ;
    sh:datatype xsd:decimal ;
    sh:optional true ;
  ] ;
  sh:property [
    sh:path dp:lowerInclusive ;
    sh:datatype xsd:boolean ;
    sh:optional true ;
  ] ;
  sh:property [
    sh:path dp:upperInclusive ;
    sh:datatype xsd:boolean ;
    sh:optional true ;
  ] ;
  sh:property [
    sh:path dp:partitionLabel ;
    sh:datatype xsd:string ;
    sh:optional true ;
  ] ;
  sh:property [
    sh:path dp:components ;
    sh:nodeKind sh:BlankNodeOrIRI ;
    sh:class dp:PartitionKeyShape ;
    sh:optional true ;
  ] ;
  # Ensure that numeric partitions have bounds
  sh:or (
    [ sh:property [ sh:path dp:partitionValue ; sh:minCount 1 ] ]
    [ sh:and (
        [ sh:property [ sh:path dp:lowerBound ; sh:minCount 1 ] ]
        [ sh:property [ sh:path dp:upperBound ; sh:minCount 1 ] ]
      )]
  ) .

# ===============================================================
# 5. Recursive check for components
# ===============================================================
dp:ComponentsShape
  a sh:NodeShape ;
  sh:property [
    sh:path dp:components ;
    sh:nodeKind sh:BlankNodeOrIRI ;
    sh:class dp:PartitionKeyShape ;
  ] .
