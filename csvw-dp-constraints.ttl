@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix csvw: <http://www.w3.org/ns/csvw#> .
@prefix dp: <https://w3id.org/csvw-dp#> .

################################################################
# TABLE LEVEL
################################################################

dp:TableShape
    a sh:NodeShape ;
    sh:targetClass csvw:Table ;

    sh:property [
        sh:path dp:maxTableLength ;
        sh:datatype xsd:positiveInteger ;
        sh:minCount 1 ;
    ] ;

    sh:property [
        sh:path dp:tableLength ;
        sh:datatype xsd:positiveInteger ;
        sh:maxCount 1 ;
    ] ;

    sh:property [
        sh:path dp:maxContributions ;
        sh:datatype xsd:positiveInteger ;
        sh:minCount 1 ;
    ] .

################################################################
# COLUMN LEVEL
################################################################

dp:ColumnShape
    a sh:NodeShape ;
    sh:targetClass csvw:Column ;

    sh:property [
        sh:path dp:nullableProportion ;
        sh:datatype xsd:decimal ;
        sh:minInclusive 0 ;
        sh:maxInclusive 1 ;
    ] ;

    sh:property [
        sh:path dp:publicPartitions ;
        sh:nodeKind sh:List ;
    ] ;

################################################################
# privacyId columns cannot define group bounds
################################################################

    sh:sparql [
        sh:message "privacyId columns cannot define partition bounds" ;
        sh:select """
            SELECT ?this
            WHERE {
              ?this dp:privacyId true .
              ?this ?p ?v .
              VALUES ?p {
                dp:maxPartitionLength
                dp:maxNumPartitions
                dp:maxInfluencedPartitions
                dp:maxPartitionContribution
              }
            }
        """ ;
    ] .

################################################################
# PARTITION DEFINITION VALIDATION
################################################################

dp:PartitionDefinitionShape
    a sh:NodeShape ;
    sh:targetClass dp:PartitionDefinition ;

    sh:property [
        sh:path dp:partitionLabel ;
        sh:datatype xsd:string ;
    ] ;

    sh:property [
        sh:path dp:lowerBound ;
        sh:datatype xsd:decimal ;
    ] ;

    sh:property [
        sh:path dp:upperBound ;
        sh:datatype xsd:decimal ;
    ] ;

################################################################
# If numeric partition exists â†’ both bounds must exist
################################################################

    sh:sparql [
        sh:message "Numeric partitions must define both lowerBound and upperBound" ;
        sh:select """
            SELECT ?this
            WHERE {
              {
                ?this dp:lowerBound ?lb .
                FILTER NOT EXISTS { ?this dp:upperBound ?ub }
              }
              UNION
              {
                ?this dp:upperBound ?ub .
                FILTER NOT EXISTS { ?this dp:lowerBound ?lb }
              }
            }
        """ ;
    ] ;

################################################################
# lowerBound < upperBound
################################################################

    sh:sparql [
        sh:message "lowerBound must be < upperBound" ;
        sh:select """
            SELECT ?this ?lb ?ub
            WHERE {
              ?this dp:lowerBound ?lb ;
                    dp:upperBound ?ub .
              FILTER (?lb >= ?ub)
            }
        """ ;
    ] .

################################################################
# GROUPABLE BOUNDS (Columns + ColumnGroups)
################################################################

dp:GroupableBoundsShape
    a sh:NodeShape ;
    sh:targetClass dp:Groupable ;

    sh:property [
        sh:path dp:maxPartitionLength ;
        sh:datatype xsd:positiveInteger ;
    ] ;

    sh:property [
        sh:path dp:maxNumPartitions ;
        sh:datatype xsd:positiveInteger ;
    ] ;

    sh:property [
        sh:path dp:maxInfluencedPartitions ;
        sh:datatype xsd:positiveInteger ;
    ] ;

    sh:property [
        sh:path dp:maxPartitionContribution ;
        sh:datatype xsd:positiveInteger ;
    ] .

################################################################
# COLUMN GROUP VALIDATION
################################################################

dp:ColumnGroupShape
    a sh:NodeShape ;
    sh:targetClass dp:ColumnGroup ;

    sh:property [
        sh:path dp:columns ;
        sh:minCount 2 ;
        sh:nodeKind sh:List ;
    ] ;

################################################################
# Cannot include privacyId column
################################################################

    sh:sparql [
        sh:message "ColumnGroup cannot include privacyId column" ;
        sh:select """
            SELECT ?this ?col
            WHERE {
              ?this dp:columns ?list .
              ?list rdf:rest*/rdf:first ?col .
              ?col dp:privacyId true .
            }
        """ ;
    ] ;

################################################################
# COLUMN GROUP WORST CASE BOUNDS
################################################################

    sh:sparql [
        sh:message "ColumnGroup maxPartitionLength exceeds constituent column bounds" ;
        sh:select """
            SELECT ?this ?groupVal ?col ?colVal
            WHERE {
              ?this dp:maxPartitionLength ?groupVal .
              ?this dp:columns ?list .
              ?list rdf:rest*/rdf:first ?col .
              ?col dp:maxPartitionLength ?colVal .
              FILTER(?groupVal > ?colVal)
            }
        """ ;
    ] .

################################################################
# REQUIRED COLUMN NULL CONSISTENCY
################################################################

dp:RequiredColumnShape
    a sh:NodeShape ;
    sh:targetClass csvw:Column ;

    sh:sparql [
        sh:message "Required columns must have nullableProportion = 0" ;
        sh:select """
            SELECT ?this
            WHERE {
              ?this csvw:required true ;
                    dp:nullableProportion ?np .
              FILTER(?np != 0)
            }
        """ ;
    ] .

################################################################
# TABLE GLOBAL WORST-CASE VALIDATION
################################################################

dp:TableConsistencyShape
    a sh:NodeShape ;
    sh:targetClass csvw:Table ;

################################################################
# Column bounds vs table bounds
################################################################

    sh:sparql [
        sh:message "Column maxPartitionLength exceeds table maxTableLength" ;
        sh:select """
            SELECT ?col ?val ?max
            WHERE {
              ?this csvw:tableSchema/csvw:column ?col .
              ?col dp:maxPartitionLength ?val .
              ?this dp:maxTableLength ?max .
              FILTER(?val > ?max)
            }
        """ ;
    ] ;

    sh:sparql [
        sh:message "Column maxInfluencedPartitions exceeds table maxContributions" ;
        sh:select """
            SELECT ?col ?val ?max
            WHERE {
              ?this csvw:tableSchema/csvw:column ?col .
              ?col dp:maxInfluencedPartitions ?val .
              ?this dp:maxContributions ?max .
              FILTER(?val > ?max)
            }
        """ ;
    ] ;

    sh:sparql [
        sh:message "Column maxPartitionContribution exceeds table maxContributions" ;
        sh:select """
            SELECT ?col ?val ?max
            WHERE {
              ?this csvw:tableSchema/csvw:column ?col .
              ?col dp:maxPartitionContribution ?val .
              ?this dp:maxContributions ?max .
              FILTER(?val > ?max)
            }
        """ ;
    ] .
