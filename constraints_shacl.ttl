@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix dp: <http://example.org/dp#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

################################################################################
# Column-level constraints
################################################################################

dp:ColumnShape
    a sh:NodeShape ;
    sh:targetClass dp:Column ;

    ########################################################################
    # If required=true, nullableProportion must be 0 (if provided)
    ########################################################################
    sh:sparql [
        sh:message "If dp:required=true, then dp:nullableProportion must be 0." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:required true ;
                  dp:nullableProportion ?np .
            FILTER(?np != 0)
        }
        """
    ] ;

    ########################################################################
    # Privacy ID columns must not have grouping fields
    ########################################################################
    sh:sparql [
        sh:message "Columns with dp:privacyId=true must not declare grouping fields." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:privacyId true .
            {
                $this dp:maxInfluencedPartitions ?v
            } UNION {
                $this dp:maxPartitionContribution ?v
            } UNION {
                $this dp:maxNumPartitions ?v
            } UNION {
                $this dp:maxPartitionLength ?v
            }
        }
        """
    ] ;

    ########################################################################
    # Public partitions must conform to declared datatype
    ########################################################################
    sh:sparql [
        sh:message "Each dp:publicPartitions value must conform to the column's declared datatype." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:publicPartitions ?pp ;
                  dp:dataType ?dt .
            FILTER(datatype(?pp) != ?dt)
        }
        """
    ] .

################################################################################
# Multi-column grouping constraints (dp:ColumnGroup)
################################################################################

dp:ColumnGroupShape
    a sh:NodeShape ;
    sh:targetClass dp:ColumnGroup ;

    ########################################################################
    # Must not include privacyId columns
    ########################################################################
    sh:sparql [
        sh:message "ColumnGroups must not include any column where dp:privacyId=true." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:columns ?col .
            ?col dp:privacyId true .
        }
        """
    ] ;

    ########################################################################
    # If any column lacks dp:publicPartitions → group must not declare it
    ########################################################################
    sh:sparql [
        sh:message "If any grouped column lacks dp:publicPartitions, the group must not declare dp:publicPartitions." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:publicPartitions ?grpPP .
            $this dp:columns ?col .
            FILTER NOT EXISTS { ?col dp:publicPartitions ?pp }
        }
        """
    ] ;

    ########################################################################
    # If any column lacks dp:maxNumPartitions → group must not declare it
    ########################################################################
    sh:sparql [
        sh:message "If any grouped column lacks dp:maxNumPartitions, the group must not declare dp:maxNumPartitions." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxNumPartitions ?grpMax .
            $this dp:columns ?col .
            FILTER NOT EXISTS { ?col dp:maxNumPartitions ?m }
        }
        """
    ] ;

    ########################################################################
    # Group maxPartitionLength = minimum of column maxPartitionLength
    # (MUST rule: only when group declares the field)
    ########################################################################
    sh:sparql [
        sh:message "dp:maxPartitionLength of group must equal the minimum across all grouped columns." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxPartitionLength ?grpLen .
            {
                SELECT $this (MIN(?len) AS ?minLen)
                WHERE {
                    $this dp:columns ?col .
                    ?col dp:maxPartitionLength ?len .
                }
                GROUP BY $this
            }
            FILTER(?grpLen != ?minLen)
        }
        """
    ] ;

    ########################################################################
    # Group maxNumPartitions ≤ product of column maxNumPartitions
    ########################################################################
    sh:sparql [
        sh:message "dp:maxNumPartitions of group must be ≤ product of grouped column dp:maxNumPartitions." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxNumPartitions ?grpMax .
            {
                SELECT $this (EXP(SUM(LOG(?m))) AS ?product)
                WHERE {
                    $this dp:columns ?col .
                    ?col dp:maxNumPartitions ?m .
                }
                GROUP BY $this
            }
            FILTER(?grpMax > ?product)
        }
        """
    ] ;

    ########################################################################
    # Group maxInfluencedPartitions = minimum of known column values (MUST)
    ########################################################################
    sh:sparql [
        sh:message "dp:maxInfluencedPartitions of group must equal the minimum of known column values." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxInfluencedPartitions ?grpVal .
            {
                SELECT $this (MIN(?v) AS ?minVal)
                WHERE {
                    $this dp:columns ?col .
                    ?col dp:maxInfluencedPartitions ?v .
                }
                GROUP BY $this
            }
            FILTER(?grpVal != ?minVal)
        }
        """
    ] ;

    ########################################################################
    # Group maxPartitionContribution = minimum of known column values (MUST)
    ########################################################################
    sh:sparql [
        sh:message "dp:maxPartitionContribution of group must equal the minimum of known column values." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxPartitionContribution ?grpVal .
            {
                SELECT $this (MIN(?v) AS ?minVal)
                WHERE {
                    $this dp:columns ?col .
                    ?col dp:maxPartitionContribution ?v .
                }
                GROUP BY $this
            }
            FILTER(?grpVal != ?minVal)
        }
        """
    ] .

################################################################################
# Table-level constraints
################################################################################

dp:TableShape
    a sh:NodeShape ;
    sh:targetClass dp:Table ;

    ########################################################################
    # tableLength == maxTableLength (if provided)
    ########################################################################
    sh:sparql [
        sh:message "If dp:tableLength is provided, it must equal dp:maxTableLength." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:tableLength ?l ;
                  dp:maxTableLength ?max .
            FILTER(?l != ?max)
        }
        """
    ] ;

    ########################################################################
    # maxPartitionLength ≤ table maxTableLength
    ########################################################################
    sh:sparql [
        sh:message "dp:maxPartitionLength of columns or groups must be ≤ dp:maxTableLength." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxTableLength ?tblMax .
            {
                ?x dp:maxPartitionLength ?len .
            }
            FILTER(?len > ?tblMax)
        }
        """
    ] ;

    ########################################################################
    # maxInfluencedPartitions ≤ table maxContributions
    ########################################################################
    sh:sparql [
        sh:message "dp:maxInfluencedPartitions must be ≤ dp:maxContributions of the table." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxContributions ?maxC .
            ?x dp:maxInfluencedPartitions ?v .
            FILTER(?v > ?maxC)
        }
        """
    ] ;

    ########################################################################
    # maxPartitionContribution ≤ table maxContributions
    ########################################################################
    sh:sparql [
        sh:message "dp:maxPartitionContribution must be ≤ dp:maxContributions of the table." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxContributions ?maxC .
            ?x dp:maxPartitionContribution ?v .
            FILTER(?v > ?maxC)
        }
        """
    ] .
