@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix dp: <http://example.org/dp#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

################################################################################
# Column-level constraints
################################################################################

dp:ColumnShape
    a sh:NodeShape ;
    sh:targetClass dp:Column ;

    ########################################################################
    # If required=true, nullableProportion must be 0 (if provided)
    ########################################################################
    sh:sparql [
        sh:message "If dp:required=true, then dp:nullableProportion must be 0." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:required true ;
                  dp:nullableProportion ?np .
            FILTER(?np != 0)
        }
        """
    ] ;

    ########################################################################
    # Privacy ID columns must not have grouping fields
    ########################################################################
    sh:sparql [
        sh:message "Columns with dp:privacyId=true must not declare grouping fields." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:privacyId true .
            {
                $this dp:maxInfluencedPartitions ?v
            } UNION {
                $this dp:maxPartitionContribution ?v
            } UNION {
                $this dp:maxNumPartitions ?v
            } UNION {
                $this dp:maxPartitionLength ?v
            }
        }
        """
    ] ;

    ########################################################################
    # Public partitions must conform to declared datatype
    ########################################################################
    sh:sparql [
        sh:message "Each dp:publicPartitions value must conform to the column's declared datatype." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:publicPartitions ?pp ;
                  dp:dataType ?dt .
            FILTER(datatype(?pp) != ?dt)
        }
        """
    ] .

################################################################################
# Multi-column grouping constraints (dp:ColumnGroup)
################################################################################

dp:ColumnGroupShape
    a sh:NodeShape ;
    sh:targetClass dp:ColumnGroup ;

    ########################################################################
    # Must not include privacyId columns
    ########################################################################
    sh:sparql [
        sh:message "ColumnGroups must not include any column where dp:privacyId=true." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:columns ?col .
            ?col dp:privacyId true .
        }
        """
    ] ;

    ########################################################################
    # If any column lacks dp:publicPartitions → group must not declare it
    ########################################################################
    sh:sparql [
        sh:message "If any grouped column lacks dp:publicPartitions, the group must not declare dp:publicPartitions." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:publicPartitions ?grpPP .
            $this dp:columns ?col .
            FILTER NOT EXISTS { ?col dp:publicPartitions ?pp }
        }
        """
    ] ;

    ########################################################################
    # If any column lacks dp:maxNumPartitions → group must not declare it
    ########################################################################
    sh:sparql [
        sh:message "If any grouped column lacks dp:maxNumPartitions, the group must not declare dp:maxNumPartitions." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxNumPartitions ?grpMax .
            $this dp:columns ?col .
            FILTER NOT EXISTS { ?col dp:maxNumPartitions ?m }
        }
        """
    ] ;

    ########################################################################
    # Group maxPartitionLength = minimum of column maxPartitionLength
    # (MUST rule: only when group declares the field)
    ########################################################################
    sh:sparql [
        sh:message "dp:maxPartitionLength of group must equal the minimum across all grouped columns." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxPartitionLength ?grpLen .
            {
                SELECT $this (MIN(?len) AS ?minLen)
                WHERE {
                    $this dp:columns ?col .
                    ?col dp:maxPartitionLength ?len .
                }
                GROUP BY $this
            }
            FILTER(?grpLen != ?minLen)
        }
        """
    ] ;

    ########################################################################
    # Group maxNumPartitions ≤ product of column maxNumPartitions
    ########################################################################
    sh:sparql [
        sh:message "dp:maxNumPartitions of group must be ≤ product of grouped column dp:maxNumPartitions." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxNumPartitions ?grpMax .
            {
                SELECT $this (EXP(SUM(LOG(?m))) AS ?product)
                WHERE {
                    $this dp:columns ?col .
                    ?col dp:maxNumPartitions ?m .
                }
                GROUP BY $this
            }
            FILTER(?grpMax > ?product)
        }
        """
    ] ;

    ########################################################################
    # Group maxInfluencedPartitions = minimum of known column values (MUST)
    ########################################################################
    sh:sparql [
        sh:message "dp:maxInfluencedPartitions of group must equal the minimum of known column values." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxInfluencedPartitions ?grpVal .
            {
                SELECT $this (MIN(?v) AS ?minVal)
                WHERE {
                    $this dp:columns ?col .
                    ?col dp:maxInfluencedPartitions ?v .
                }
                GROUP BY $this
            }
            FILTER(?grpVal != ?minVal)
        }
        """
    ] ;

    ########################################################################
    # Group maxPartitionContribution = minimum of known column values (MUST)
    ########################################################################
    sh:sparql [
        sh:message "dp:maxPartitionContribution of group must equal the minimum of known column values." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxPartitionContribution ?grpVal .
            {
                SELECT $this (MIN(?v) AS ?minVal)
                WHERE {
                    $this dp:columns ?col .
                    ?col dp:maxPartitionContribution ?v .
                }
                GROUP BY $this
            }
            FILTER(?grpVal != ?minVal)
        }
        """
    ] .

################################################################################
# Table-level constraints
################################################################################

dp:TableShape
    a sh:NodeShape ;
    sh:targetClass dp:Table ;

    ########################################################################
    # tableLength == maxTableLength (if provided)
    ########################################################################
    sh:sparql [
        sh:message "If dp:tableLength is provided, it must equal dp:maxTableLength." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:tableLength ?l ;
                  dp:maxTableLength ?max .
            FILTER(?l != ?max)
        }
        """
    ] ;

    ########################################################################
    # maxPartitionLength ≤ table maxTableLength
    ########################################################################
    sh:sparql [
        sh:message "dp:maxPartitionLength of columns or groups must be ≤ dp:maxTableLength." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxTableLength ?tblMax .
            {
                ?x dp:maxPartitionLength ?len .
            }
            FILTER(?len > ?tblMax)
        }
        """
    ] ;

    ########################################################################
    # maxInfluencedPartitions ≤ table maxContributions
    ########################################################################
    sh:sparql [
        sh:message "dp:maxInfluencedPartitions must be ≤ dp:maxContributions of the table." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxContributions ?maxC .
            ?x dp:maxInfluencedPartitions ?v .
            FILTER(?v > ?maxC)
        }
        """
    ] ;

    ########################################################################
    # maxPartitionContribution ≤ table maxContributions
    ########################################################################
    sh:sparql [
        sh:message "dp:maxPartitionContribution must be ≤ dp:maxContributions of the table." ;
        sh:select """
        SELECT $this
        WHERE {
            $this dp:maxContributions ?maxC .
            ?x dp:maxPartitionContribution ?v .
            FILTER(?v > ?maxC)
        }
        """
    ] .

################################################################################
# Virtual Columns constraints
################################################################################
dp:DerivedFromOnlyOnVirtualShape
  a sh:NodeShape ;
  sh:targetSubjectsOf dp:derivedFrom ;
  sh:property [
    sh:path csvw:virtual ;
    sh:hasValue true ;
    sh:message "dp:derivedFrom may only be used on virtual columns (csvw:virtual = true)." ;
  ] .

dp:VirtualColumnsShouldDeclareDerivedFromShape
  a sh:NodeShape ;
  sh:targetClass csvw:Column ;
  sh:property [
    sh:path csvw:virtual ;
    sh:hasValue true ;
  ] ;
  sh:property [
    sh:path dp:derivedFrom ;
    sh:minCount 1 ;
    sh:severity sh:Warning ;
    sh:message "Virtual columns SHOULD declare dp:derivedFrom to document provenance and support DP validation." ;
  ] .

dp:DerivedMaxContributionsMonotonicShape
  a sh:NodeShape ;
  sh:targetSubjectsOf dp:derivedFrom ;
  sh:sparql [
    sh:message "Derived dp:maxContributions must be ≤ source dp:maxContributions." ;
    sh:select """
      SELECT $this WHERE {
        $this dp:derivedFrom ?src .
        $this dp:maxContributions ?d .
        ?src dp:maxContributions ?s .
        FILTER (?d > ?s)
      }
    """ ;
  ] .

dp:DerivedMaxTableLengthMonotonicShape
  a sh:NodeShape ;
  sh:targetSubjectsOf dp:derivedFrom ;
  sh:sparql [
    sh:message "Derived dp:maxTableLength must be ≤ source dp:maxTableLength." ;
    sh:select """
      SELECT $this WHERE {
        $this dp:derivedFrom ?src .
        $this dp:maxTableLength ?d .
        ?src dp:maxTableLength ?s .
        FILTER (?d > ?s)
      }
    """ ;
  ] .

dp:DerivedMaxNumPartitionsMonotonicShape
  a sh:NodeShape ;
  sh:targetSubjectsOf dp:derivedFrom ;
  sh:sparql [
    sh:message "Derived dp:maxNumPartitions must be ≤ source dp:maxNumPartitions." ;
    sh:select """
      SELECT $this WHERE {
        $this dp:derivedFrom ?src .
        $this dp:maxNumPartitions ?d .
        ?src dp:maxNumPartitions ?s .
        FILTER (?d > ?s)
      }
    """ ;
  ] .

dp:DerivedNumericRangeMonotonicShape
  a sh:NodeShape ;
  sh:targetSubjectsOf dp:derivedFrom ;
  sh:sparql [
    sh:message "Derived numeric range must be tighter: minimum ≥ source minimum AND maximum ≤ source maximum." ;
    sh:select """
      SELECT $this WHERE {
        $this dp:derivedFrom ?src .
        OPTIONAL { $this csvw:minimum ?dmin . }
        OPTIONAL { $this csvw:maximum ?dmax . }
        OPTIONAL { ?src csvw:minimum ?smin . }
        OPTIONAL { ?src csvw:maximum ?smax . }
        FILTER (
          (bound(?dmin) && bound(?smin) && ?dmin < ?smin) ||
          (bound(?dmax) && bound(?smax) && ?dmax > ?smax)
        )
      }
    """ ;
  ] .

dp:BinningRequiresPublicPartitionsShape
  a sh:NodeShape ;
  sh:targetSubjectsOf dp:transformationType ;
  sh:sparql [
    sh:message "Columns with dp:transformationType = 'bin' MUST define dp:publicPartitions." ;
    sh:select """
      SELECT $this WHERE {
        $this dp:transformationType "bin" .
        FILTER NOT EXISTS { $this dp:publicPartitions ?p }
      }
    """ ;
  ] .

dp:ClippingRequiresBoundsShape
  a sh:NodeShape ;
  sh:targetSubjectsOf dp:transformationType ;
  sh:sparql [
    sh:message "Columns with dp:transformationType = 'clip' MUST define both csvw:minimum and csvw:maximum." ;
    sh:select """
      SELECT $this WHERE {
        $this dp:transformationType "clip" .
        FILTER NOT EXISTS { $this csvw:minimum ?m } ||
        FILTER NOT EXISTS { $this csvw:maximum ?M }
      }
    """ ;
  ] .

dp:TruncationRequiresMaxContributionsShape
  a sh:NodeShape ;
  sh:targetSubjectsOf dp:transformationType ;
  sh:sparql [
    sh:message "Columns with dp:transformationType = 'truncate' MUST define dp:maxContributions." ;
    sh:select """
      SELECT $this WHERE {
        $this dp:transformationType "truncate" .
        FILTER NOT EXISTS { $this dp:maxContributions ?m }
      }
    """ ;
  ] .

dp:RecodingRequiresPublicPartitionsShape
  a sh:NodeShape ;
  sh:targetSubjectsOf dp:transformationType ;
  sh:sparql [
    sh:message "Columns with dp:transformationType = 'recode' MUST define dp:publicPartitions." ;
    sh:select """
      SELECT $this WHERE {
        $this dp:transformationType "recode" .
        FILTER NOT EXISTS { $this dp:publicPartitions ?p }
      }
    """ ;
  ] .

dp:FilteringShouldReduceTableLengthShape
  a sh:NodeShape ;
  sh:targetSubjectsOf dp:transformationType ;
  sh:sparql [
    sh:severity sh:Warning ;
    sh:message "Filtering SHOULD reduce dp:maxTableLength relative to source." ;
    sh:select """
      SELECT $this WHERE {
        $this dp:transformationType "filter" .
        $this dp:derivedFrom ?src .
        $this dp:maxTableLength ?d .
        ?src dp:maxTableLength ?s .
        FILTER (?d = ?s)
      }
    """ ;
  ] .



